<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>AI Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json"> <!-- highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background: #1a1a1a;
            color: #eee;
            display: flex;
            height: 100vh;
        }

        /* Левая панель */
        #sidebar {
            width: 260px;
            background: #111;
            padding: 15px;
            box-sizing: border-box;
            border-right: 1px solid #333;
            overflow-y: auto;
        }

        /* Правая часть */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Чат */
        #chat {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .msg-user {
            margin: 8px 0;
            padding: 8px;
            background: #2e2e2e;
            border-radius: 6px;
        }

        .msg-ai {
            margin: 8px 0;
            padding: 8px;
            background: #3a3a3a;
            border-radius: 6px;
        }

        /* КОД БЛОКИ */
        .code-block {
            background: #222;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            position: relative;
            margin: 10px 0;
        }

        .copy-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #444;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            color: #eee;
        }

        .copy-btn:hover {
            background: #555;
        }

        /* Ввод */
        #input-box {
            padding: 10px;
            display: flex;
            gap: 8px;
            border-top: 1px solid #333;
            background: #111;
        }

        #msg {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            border: none;
            background: #2b2b2b;
            color: #eee;
        }

        button {
            padding: 10px 14px;
            background: #444;
            border: none;
            color: #eee;
            cursor: pointer;
        }

        button:hover {
            background: #555;
        }

        /* Мобильный вид */
        @media (max-width: 700px) {
            #sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #333;
            }

            body {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <h3>Настройки</h3>

        <label>API ключ:</label>
        <input id="key" type="password"
            style="width:100%; margin-bottom:10px; background:#222; color:#eee; border:none; padding:8px;">

        <label>Модель:</label>
        <input id="model" type="text" value="gpt-5.2-chat-latest"
            style="width:100%; margin-bottom:10px; background:#222; color:#eee; border:none; padding:8px;">

        <button onclick="clearHistory()" style="margin-top:10px; width:100%;">Очистить историю</button>
    </div>
    <div id="main">
        <div id="chat"></div>
        <div id="input-box"> <input id="msg" type="text" placeholder="Ваш запрос..."> <button
                onclick="sendMsg()">Отправить</button> </div>
    </div>
    <script> let historyData = JSON.parse(localStorage.getItem("chat_history") || "[]"); const chat = document.getElementById("chat"); function renderHistory() { chat.innerHTML = ""; for (const item of historyData) { const div = document.createElement("div"); div.className = item.role === "user" ? "msg-user" : "msg-ai"; if (item.role === "assistant") { div.innerHTML = formatMessage(item.text); } else { div.textContent = item.text; } chat.appendChild(div); } chat.scrollTop = chat.scrollHeight; highlightAll(); } /* Авто‑подсветка кода */ function highlightAll() { document.querySelectorAll("pre code").forEach(block => { hljs.highlightElement(block); }); } /* Формирование HTML с кодом */ function formatMessage(text) {
            const parts = text.split(/```/); let html = ""; for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 1) {
                    const code = parts[i].trim(); html += '<div class="code-block">' + '<button class="copy-btn" onclick="copyCode(this)">Скопировать</button>' + '<pre><code>' + code.replace(/</g, "&lt;") + '</code></pre>' +

                        '</div>';
                } else {
                    html += "<div>" + parts[i] + "</div>";
                }

            }
            return html;
        }

        /* Кнопка копирования */
        function copyCode(btn) {
            const code = btn.parentElement.querySelector("pre").innerText;
            navigator.clipboard.writeText(code);
            btn.textContent = "Скопировано!";
            setTimeout(() => btn.textContent = "Копировать", 1500);
        }

        /* Отправка сообщения */
        async function sendMsg() {
            const key = document.getElementById("key").value;
            const model = document.getElementById("model").value;
            const msg = document.getElementById("msg").value;
            if (!msg) return;

            addMessage("user", msg);
            document.getElementById("msg").value = "";

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + key
                },
                body: JSON.stringify({
                    model: model,
                    messages: historyData
                        .map(x => ({ role: x.role, content: x.text }))
                        .concat({ role: "user", content: msg })
                })
            });

            const data = await response.json();
            const answer = data.choices?.[0]?.message?.content || "Нет ответа";

            addMessage("assistant", answer);
        }

        /* Добавление в историю */
        function addMessage(role, text) {
            historyData.push({ role, text });
            localStorage.setItem("chat_history", JSON.stringify(historyData));
            renderHistory();
        }

        function clearHistory() {
            historyData = [];
            localStorage.setItem("chat_history", "[]");
            renderHistory();
        }

        /* Enter = отправка */
        document.getElementById("msg").addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });
    </script>
    <script> if ("serviceWorker" in navigator) { navigator.serviceWorker.register("sw.js"); } </script>
</body>

</html>
